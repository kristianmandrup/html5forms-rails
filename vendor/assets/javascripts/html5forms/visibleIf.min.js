/*
 * This notice must be untouched at all times.
 * 
 * visibleIf.js - a cross browser form field manager that hides and shows
 * form fields depending on the values of other form fields.
 *
 * Version 1.0 released Feb 21, 2009
 * Version 2.0 (this release) released June 20, 2010.  Features new 
 *   rules engine originally developed for HTML5Widgets.js and HTML5 custom
 *   data- attribute support. 
 *
 * Written by: Zoltan Hawryluk. 
 * 
 * Latest release available at http://www.useragentman.com/
 *
 * released under the MIT License:
 *   http://www.opensource.org/licenses/mit-license.php
 */
var visibleIf=new function(){var me=this;var formInputCache=new Array();var changedInput=null;var visibleIfNodes;var mandatoryNodes;var varRe=/\s([a-zA-Z][a-zA-Z0-9\.]*)\s/g;var operatorRe=/\s*(~|!=|==|>={0,1}|<={0,1})\s*/g;var leftBkRe=/\(/g;var rightBkRe=/\)/g;var reRe=/~ \"([^\"]*)\"/g;var equalsRe=/ == /g;var quotedStringRe=/"[^"]*"/g;var quotedStringOneOnlyRe=/"[^"]*"/;var placeHolderString='_pLaCeHoLdEr_';var placeHolderRe=new RegExp(placeHolderString);var nodesWithEventsAttached=new Array();var inputsToClear;var req=null;var nameCounter=0;var CSSHelpers,StringHelpers,XMLHelpers,DOMHelpers;me.init=function(reset){if(EventHelpers.hasPageLoadHappened(arguments)&&!reset){return}visibleIfNodes=CSSHelpers.getElementsByClassName(document,'visibleIf');mandatoryNodes=CSSHelpers.getElementsByClassName(document,'mandatoryIf');removeDisabledNodes();me.refreshPage({isPageLoad:true});setMandatoryStates();setEvents()}function removeDisabledNodes(){for(var i=0;i<visibleIfNodes.length;i++){var node=visibleIfNodes[i];var els=getAllFormElementsIn(node)for(var j=0;j<els.length;j++){var el=els[j];el.disabled=false}}}function refreshPageEvent(e){me.refreshPage()}me.refreshPage=function(options){changedInput=this;inputsToClear=new Array();qsSb=new StringBuffer();for(var i=0;i<visibleIfNodes.length;i++){setVisibility(visibleIfNodes[i],options)}if(!(options&&!options.isPageLoaded)){for(i in inputsToClear){var el=inputsToClear[i];if(i!=0){qsSb.append('&')}qsSb.append(i).append('=')}var qs=qsSb.toString();if(qsSb.getLength()>0){var url=DOMHelpers.getDatasetItem(document.body,'visibleif-deletedataurl');if(url){req=XMLHelpers.getXMLHttpRequest(url,deleteRequestHandler,'GET',qs)}}for(var i=0;i<mandatoryNodes.length;i++){setMandatoryStates(mandatoryNodes[i],options)}}var formNodes=document.getElementsByTagName('form');for(var i=0;i<formNodes.length;i++){updateVisibilityProperties(formNodes[i])}}function setMandatoryStates(e){changedInput=this;for(var i=0;i<mandatoryNodes.length;i++){setMandatoryState(mandatoryNodes[i])}}function getRule(node,type){var r=DOMHelpers.getDatasetItem(node,type);if(!r){r=CSSHelpers.getElementsByClassName(node,type);if(r.length==0){r=null}else{r=r[0].innerHTML.trim()}}if(r){r=StringHelpers.unentify(" "+r.replace(operatorRe,' $1 ')+" ")}return r}function setEvents(){visibleIfNodes=CSSHelpers.getElementsByClassName(document,'visibleIf');mandatoryNodes=CSSHelpers.getElementsByClassName(document,'mandatoryIf');var nodesToIndex=[visibleIfNodes,mandatoryNodes];var nameCounter=0;var forms=document.getElementsByTagName('form');for(var i=0;i<forms.length;i++){EventHelpers.addEvent(forms[i],'submit',formSubmitEvent)}for(var n=0;n<nodesToIndex.length;n++){var nodes=nodesToIndex[n];for(var i=0;i<nodes.length;i++){var node=nodes[i];var parentForm=DOMHelpers.getAncestorByTagName(node,'form');var rule;var ruleType;if(n==0){ruleType="visibleIf-rule"}else{ruleType="mandatoryIf-rule"}rule=getRule(node,ruleType);if(!rule){throw"There is no rule for with the node with the following HTML:"+XMLHelpers.getOuterXML(node)}var inputVars=getInputVars(rule);if(inputVars){for(var j=0;j<inputVars.length;j++){var inputVar=inputVars[j];if(!nodesWithEventsAttached[parentForm.id]||!nodesWithEventsAttached[parentForm.id][inputVar]){if(!nodesWithEventsAttached[parentForm.id]){nodesWithEventsAttached[parentForm.id]=new Array()}nodesWithEventsAttached[parentForm.id][inputVar]=true;if(inputVars.length>0){var fieldNode=parentForm[inputVars[j]];if(fieldNode!=null){if(fieldNode.nodeName!="SELECT"&&fieldNode.length){for(var k=0;k<fieldNode.length;k++){EventHelpers.addEvent(fieldNode[k],'click',refreshPageEvent)}}else{EventHelpers.addEvent(fieldNode,'change',refreshPageEvent)}if(fieldNode.type=='text'){EventHelpers.addEvent(fieldNode,'change',refreshPageEvent)}if(fieldNode.type=='checkbox'){EventHelpers.addEvent(fieldNode,'click',refreshPageEvent)}}}}}}}}}function updateVisibilityProperties(formNode){var fields=formNode.elements;for(var i=0;i<fields.length;i++){var field=fields[i]if(!isVisible(field)&&!CSSHelpers.isMemberOfClass(field,'visibleIf-submitIfInvisible')){CSSHelpers.addClass(field,'visibleIf-notSubmitted');field.disabled=true}else{CSSHelpers.removeClass(field,'visibleIf-notSubmitted');field.disabled=false}}}function formSubmitEvent(e){if(CSSHelpers.isMemberOfClass(this,'visibleIf-submitInvisibleData')){return}updateVisibilityProperties(this)}function isVisible(node){return node.offsetWidth!=0}function setVisibility(node,options){var rule=getRule(node,'visibleIf-rule')if(rule==null){throw"There is no rule for with the node with the following HTML:"+XMLHelpers.getOuterXML(node)}var isRuleTrue=evaluateRule(DOMHelpers.getAncestorByTagName(node,'form'),rule);if(isRuleTrue){CSSHelpers.addClass(node,'visibleIf-visible');setFormElementsInside(node,false,options)}else{CSSHelpers.removeClass(node,'visibleIf-visible');if(options&&options.isPageLoad){setFormElementsInside(node,false,options)}else{setFormElementsInside(node,true,options)}}}function setMandatoryState(node){var rule=getRule(node,'mandatoryIf-rule')if(rule==null){throw"There is no rule for with the node with the following HTML:"+XMLHelpers.getOuterXML(node)}var isRuleTrue=evaluateRule(DOMHelpers.getAncestorByTagName(node,'form'),getRule(node,rule));if(isRuleTrue){CSSHelpers.addClass(node,'mandatoryIf-mandatory')}else{CSSHelpers.removeClass(node,'mandatoryIf-mandatory')}}function evaluateRule(parentForm,rule){if(rule==""){return true}else{if(rule!=null){if(!parentForm){throw"Error: the rule "+rule+" is not attached to a form."}var stringToEval;var formElem=parentForm[rule.name];var diddledRule=rule.replace(quotedStringRe,placeHolderString);var quotedVals=rule.match(quotedStringRe);var formId=parentForm.id;if(!formId){formId='visibleIf-form'+nameCounter;parentForm.id=formId;nameCounter++}stringToEval=diddledRule.replace(leftBkRe,'( ').replace(rightBkRe,' )').replace(varRe,'getFieldValue(document.getElementById("'+formId+'")["$1"]) ').replace(reRe,'.match(/$1/)');if(quotedVals){for(var i=0;i<quotedVals.length;i++){stringToEval=stringToEval.replace(placeHolderRe,quotedVals[i])}}try{if(eval(stringToEval)){return true}else{return false}}catch(ex){return false}}}}function setFormElementsInside(node,doClear,options){if(!options){options={}}var formElements=getAllFormElementsIn(node);for(var i=0;i<formElements.length;i++){var el=formElements[i];if(el!=changedInput){switch(el.nodeName){case"INPUT":switch(el.type){case"checkbox":if(el.checked){if(doClear){if(!CSSHelpers.isMemberOfClass(el,'visibleIf-doNotReset')){formCache.setValue(el.name,el.value);el.checked=false;addToInputToClear(el)}}else if(formCache.getValue(el.name)==el.value){}}break;case"radio":if(doClear){if(!CSSHelpers.isMemberOfClass(el,'visibleIf-doNotReset')){if(el.checked){formCache.setValue(el.name,el.value);el.checked=false}addToInputToClear(el)}}else if(formCache.getValue(el.name)==el.value){}break;case"file":break;case"hidden":break;default:if(doClear){if(CSSHelpers.isMemberOfClass(el,'fileList_fileDisplay')){CSSHelpers.removeClass(el,'fileList_fileDisplay');el.disabled=false;el.name=el.name.replace("_ignore","")var html=XMLHelpers.getOuterXML(el).replace(/text/,'file');el.parentNode.innerHTML=html;url=config.getScriptedValue('visibleIf.urls.deleteFiles',{files:StringHelpers.urlencode(el.value),formProperty:el.name})req=XMLHelpers.getXMLHttpRequest(url,deleteRequestHandler)}formCache.setValue(el.name,el.value);if(options.isPageLoad){el.value=DOMHelpers.getAttributeValue(el,'value');if(el.value=="null"){el.value=""}}else if(!CSSHelpers.isMemberOfClass(el,'visibleIf-doNotReset')){el.value="";addToInputToClear(el)}}else{}break}break;case"TEXTAREA":if(doClear){formCache.setValue(el.name,el.value);if(options.isPageLoad){}else if(!CSSHelpers.isMemberOfClass(el,'visibleIf-doNotReset')){el.value="";addToInputToClear(el)}}else{}break;case"SELECT":if(doClear){if(!CSSHelpers.isMemberOfClass(el,'visibleIf-doNotReset')){formCache.setValue(el.name,el.selectedIndex);el.selectedIndex=0;addToInputToClear(el)}el.disabled=true}else{el.disabled=false}break}}}}function addToInputToClear(el){if(!inputsToClear[el.name]){inputsToClear[el.name]=el}}function deleteRequestHandler(){if(!req){return}if(req.readyState==ReadyState.COMPLETED){if(req.status==HttpCode.OK||req.status==HttpCode.LOCAL_OK){}else{throw"Something bad happened.  HTTP Status: "+req.status}}}function getInputVars(rule){rule=rule.replace(leftBkRe,'( ').replace(rightBkRe,' )');var vars=rule.match(varRe);if(vars==null){return new Array()}for(var i=0;i<vars.length;i++){vars[i]=vars[i].trim()}return vars}function getFieldValue(formElementNode){var r="";var type;type=formElementNode.type if(!type){if(formElementNode.length)type=formElementNode[0].type}switch(type){case'text':case'hidden':case'password':case'textarea':case'select-one':r=formElementNode.value;case'checkbox':if(formElementNode.checked){r=formElementNode.value}break;case'radio':for(var i=0;i<formElementNode.length;i++){if(formElementNode[i].checked){r=formElementNode[i].value;break}}}if(formElementNode.length){for(var i=0;i<formElementNode.length;i++){if(formElementNode[i].checked){r=formElementNode[i].value}}}return r.replace('\n','').replace('   ','')}function getAllFormElementsIn(node){if(!node){node=document}var r=new Array();var elems={inputs:node.getElementsByTagName('input'),selects:node.getElementsByTagName('select'),textareas:node.getElementsByTagName('textarea')};for(var i in elems){var elem=elems[i];for(j=0;j<elem.length;j++){r.push(elem[j])}}return r}if(window.CSSHelpers){CSSHelpers=window.CSSHelpers}else{CSSHelpers=new function(){var me=this;var blankRe=new RegExp('\\s');function getClassReString(className){return'\\s'+className+'\\s|^'+className+'\\s|\\s'+className+'$|'+'^'+className+'$'}function getClassPrefixReString(className){return'\\s'+className+'-[0-9a-zA-Z_]+\\s|^'+className+'[0-9a-zA-Z_]+\\s|\\s'+className+'[0-9a-zA-Z_]+$|'+'^'+className+'[0-9a-zA-Z_]+$'}me.addClass=function(obj,className){if(blankRe.test(className)){return}if(!me.isMemberOfClass(obj,className)){obj.className+=" "+className}}me.removeClass=function(obj,className){if(blankRe.test(className)){return}var re=new RegExp(getClassReString(className),"g");var oldClassName=obj.className;if(obj.className){obj.className=oldClassName.replace(re,'')}}me.getElementsByClassName=function(obj,className){if(obj.getElementsByClassName){return DOMHelpers.nodeListToArray(obj.getElementsByClassName(className))}else{var a=[];var re=new RegExp(getClassReString(className));var els=DOMHelpers.getAllDescendants(obj);for(var i=0,j=els.length;i<j;i++){if(re.test(els[i].className)){a.push(els[i])}}return a}}me.isMemberOfClass=function(obj,className){if(blankRe.test(className))return false;var re=new RegExp(getClassReString(className),"g");return(re.test(obj.className))}}}if(window.DOMHelpers){DOMHelpers=window.DOMHelpers}else{DOMHelpers=new function(){var me=this;me.getAllDescendants=function(obj){return obj.all?obj.all:obj.getElementsByTagName('*')}me.getAncestorByTagName=function(obj,tagName){for(var node=obj.parentNode;node.nodeName.toLowerCase()!='body';node=node.parentNode){if(tagName.toLowerCase()==node.nodeName.toLowerCase()){return node}}return null}me.getAttributeByName=function(obj,attrName){var i;var attributes=obj.attributes;for(i=0;i<attributes.length;i++){var attr=attributes[i]if(attr.nodeName==attrName&&attr.specified){return attr}}return null}me.getAttributeValue=function(obj,attrName){var attr=me.getAttributeByName(obj,attrName);if(attr!=null){return attr.nodeValue}else{return null}}me.getDatasetItem=function(obj,name){var r=DOMHelpers.getAttributeValue(obj,'data-'+name);if(!r){r=DOMHelpers.getAttributeValue(obj,'data-'+name.toLowerCase())}return r}me.nodeListToArray=function(nodeList){var ary=[];for(var i=0,len=nodeList.length;i<len;i++){ary.push(nodeList[i])}return ary}}}if(window.StringHelpers){StringHelpers=window.StringHelpers}else{StringHelpers=new function(){var me=this;me.initWhitespaceRe=/^\s\s*/;me.endWhitespaceRe=/\s\s*$/;me.whitespaceRe=/\s/;me.unentify=function(s){return s.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>')}me.urlencode=function(str){return escape(str).replace('+','%2B').replace('%20','+').replace('*','%2A').replace('/','%2F').replace('@','%40')}}}if(window.XMLHelpers){XMLHelpers=window.XMLHelpers}else{XMLHelpers=new function(){var me=this;me.getOuterXML=function(node,options){var r;if(node.xml){r=node.xml}else if(node.outerHTML){r=node.outerHTML}else if(window.XMLSerializer){var serializer=new XMLSerializer();var text=serializer.serializeToString(node);r=text}else{return null}if(options){if(options.insertClosingTags){r=r.replace(selfClosingTagRe,"<$1></$1>")}}return r}me.getXMLHttpRequest=function(url,processReqChange){var argv=me.getXMLHttpRequest.arguments;var argc=me.getXMLHttpRequest.arguments.length;var httpMethod=(argc>2)?argv[2]:'GET';var data=(argc>3)?argv[3]:"";var isAsync=(argc>4)?argv[4]:true;var req;if(window.XMLHttpRequest){req=new XMLHttpRequest()}else if(window.ActiveXObject){try{req=new ActiveXObject('Msxml2.XMLHTTP')}catch(ex){req=new ActiveXObject("Microsoft.XMLHTTP")}}else{return null}if(isAsync){req.onreadystatechange=processReqChange}if(httpMethod=="GET"&&data!=""){url+="?"+data}req.open(httpMethod,url,isAsync);req.setRequestHeader("If-Modified-Since","Sat, 1 Jan 2000 00:00:00 GMT");req.send(data);return req}}}function StringBuffer(){var me=this;var buffer=[];me.append=function(string){buffer.push(string);return me}me.appendBuffer=function(bufferToAppend){buffer=buffer.concat(bufferToAppend)}me.toString=function(){return buffer.join("")}me.getLength=function(){return buffer.length}me.flush=function(){buffer.length=0}}String.prototype.trim=function(){var str=this;if(this.length>6000){str=this.replace(StringHelpers.initWhitespaceRe,'');var i=str.length;while(StringHelpers.whitespaceRe.test(str.charAt(--i)));return str.slice(0,i+1)}else{return this.replace(StringHelpers.initWhitespaceRe,'').replace(StringHelpers.endWhitespaceRe,'')}}}var formCache=new function(){var me=this;var values=new Array();me.setValue=function(name,value){values[name]=value}me.getValue=function(name){if(values[name]==undefined){return""}else{return values[name]}}}EventHelpers.addPageLoadEvent('visibleIf.init');